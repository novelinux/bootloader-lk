ARM 上电启动 - s3c2440
================================================================================

ARM上电取第一条指令流程
--------------------------------------------------------------------------------

#### 上电后的第一条指令在哪里？

首先明确：对于ARM芯片，启动时pc值由CPU设计者规定，不同的ARM CPU有不同的值，例如S3C2440芯片上电后
PC值被硬件设计者规定为0x0；其他ARM芯片不一定是0x0。

S3C2440的启动时读取的第一条指令是在内存0x0地址处，不管是从nand flash还是nor flash启动。

但是上电后内存中是没有数据的，那么0x00地址处的指令是如何放进去的？
针对不同的flash(Nand Flash, NorFlash）, 操作方式是不同的，下面讲述从NandFlash和NorFlash启动的
不同流程。

#### NorFlash和NandFlash的异同

* NandFlash: 价格低，容量大，适合大容量数据存储，地址线和数据线共用I/O线，所有信息都通过一条线传送，类比于PC的硬盘，
* NorFlash: 价格贵，容量小，适合小容量的程序或数据存储，类似硬盘，但是能在其中运行程序；有独立地址线、数据线
* SDRAM：主要用于程序执行时的程序存储、执行或计算，类比于PC的内存；

综上, NorFlash比较适合频繁随即读写的场合，通常用于存储代码并直接在其中运行;NandFlash用于存储资料。

#### ARM从NandFlash启动

若从NandFlash启动，上电后NandFlash控制器自动把NandFlash存储器中的0 ~ 4K内容加载到芯片内的起步石
(Steppingstone，起步石这个机制是处理器中集成的功能，对程序员透明)，即内部SRAM缓冲器中，同时把内部
SRAM的起始地址设置为0x0（不同的CPU上电后的PC值不尽相同，对不同的CPU该值也不尽相同），然后把这段
片内SRAM映射到nGCS0片选的空间，进而CPU开始从内部SRAM的0x0处开始取得第一条指令，该过程全部是硬件
自动完成，不需要程序代码控制。

或许你有个疑问，为什么不能直接把NandFlash映射到0x0地址处？非要经过内部SRAM缓冲？

答案是，NandFlash根本没有地址线，没法直接映射，必须使用SRAM做一个载体，通过SRAM把剩余的NandFlash
代码复制到SDRAM中运行。
若想从NandFlash启动，那么uboot最核心的代码必须放在前4k完成。这4k代码要完成ARM CPU的核心配置以及
将剩余的代码拷贝到SDRAM中(若从NorFlash启动则没有4k这个大小的限制，但是还会在完成最主要的设置后
进入SDRAM中运行）。

#### ARM从NorFlash启动

若从NorFlash启动，则NorFlash直接被映射到内存的0x0地址处(就是nGCS0，这里就不需要片内SRAM来辅助了，
所以片内SRAM的起始地址不变，还是0x40000000)，然后cpu从0x00000000开始执行(也就是在Norfalsh中执行).

需要说明的是，uboot代码段(.text段)起始位置必须是与上电后PC值一致，即编译uboot时，TEXT_BASE宏必须
设置成0x0 ，反汇编uboot文件后，文本段第一条指令的地址也是0.

总结：

* 从NorFlash还是从NandFlash启动，是由ARM的OM1和OM0引脚组合决定
* 不管从NorFlash还是NandFlash启动，S3C2440上电后的pc值为0x0
* 如果某芯片上电后PC值不是0x0，假如是0x38ff0000，那么从NorFlash启动时，硬件就要自动将其映射到
  0x38ff0000地址处；如果从NandFlash启动，那么硬件就要自动将NandFlash中的前4K内容加载到0x38ff0000
  地址处。